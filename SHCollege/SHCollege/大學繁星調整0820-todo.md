# 大學繁星調整0820 - Todo 清單

## Todo 1: 調整 ScoreForm.cs 第857行的 _getScoreCalcRule 資料來源

### 任務描述
參考 `ScoreForm111.cs` 第864行的實作，調整 `ScoreForm.cs` 第857行的 `_getScoreCalcRule` 資料來源，確保兩個檔案在成績計算功能上的一致性。

### 目標位置
- **來源檔案**: `Forms/ScoreForm111.cs` 第864行
- **目標檔案**: `Forms/ScoreForm.cs` 第857行

### 當前狀態分析

#### ScoreForm111.cs 第864行 (參考實作)
```csharp
var entryScores = ScoreCalcHelper.CalcSemesterEntryScore(subjRows, sid, g, s, _getScoreCalcRule, _chkSScore);
```

**優勢：**
- ✅ `_getScoreCalcRule` 方法有完整實作
- ✅ 使用 `StudentScoreCalcRules` 字典儲存資料
- ✅ 從 `Utility.GetStudentScoreCalcRules()` 取得實際資料
- ✅ 包含完整的錯誤處理和 XML 解析邏輯
- ✅ 支援動態成績計算規則

#### ScoreForm.cs 第857行 (需要調整)
```csharp
var entryScores = ScoreCalcHelper.CalcSemesterEntryScore(subjRows, sid, g, s, _getScoreCalcRule, _chkSScore);
```

**問題：**
- ❌ `_getScoreCalcRule` 方法僅為範例實作
- ❌ 直接回傳 `null`，沒有實際資料來源
- ❌ 缺少錯誤處理機制
- ❌ 無法支援動態成績計算

### 需要調整的內容

#### 1. 加入 StudentScoreCalcRules 字典宣告
```csharp
// 在 ScoreForm 類別中加入
Dictionary<string, string> StudentScoreCalcRules;
```

#### 2. 在 _bgExporData_DoWork 方法中初始化資料
```csharp
// 在取得再次修習成績後加入
StudentScoreCalcRules = Utility.GetStudentScoreCalcRules(StudentIDList);
```

#### 3. 更新 _getScoreCalcRule 方法實作
```csharp
private System.Xml.XmlElement _getScoreCalcRule(string studentID)
{
    try
    {
        // 檢查是否有學生成績計算規則資料
        if (StudentScoreCalcRules == null || !StudentScoreCalcRules.ContainsKey(studentID))
        {
            return null;
        }

        // 取得學生的成績計算規則 XML 內容
        string xmlContent = StudentScoreCalcRules[studentID];

        // 如果沒有規則內容，回傳 null
        if (string.IsNullOrEmpty(xmlContent))
        {
            return null;
        }

        // 建立 XML 文件並載入內容
        System.Xml.XmlDocument xmlDoc = new System.Xml.XmlDocument();
        xmlDoc.LoadXml(xmlContent);

        // 回傳根元素
        return xmlDoc.DocumentElement;
    }
    catch (Exception ex)
    {
        // 記錄錯誤訊息
        System.Diagnostics.Debug.WriteLine($"解析學生成績計算規則時發生錯誤: {ex.Message}");
        return null;
    }
}
```

### 預期效果
調整完成後，`ScoreForm.cs` 將能夠：
- 正常取得學生成績計算規則
- 支援動態成績計算
- 與 `ScoreForm111.cs` 保持功能一致性

### 注意事項
- 確保 `Utility.GetStudentScoreCalcRules()` 方法可用
- 測試 XML 解析邏輯是否正常運作
- 驗證錯誤處理機制是否有效
- 確認成績計算結果的一致性

---

## Todo 2: 調整 ScoreForm103_1.cs 第890行的 _getScoreCalcRule 資料來源

### 任務描述
參考 `ScoreForm111.cs` 第864行的實作，調整 `ScoreForm103_1.cs` 第890行的 `_getScoreCalcRule` 資料來源，確保該檔案在成績計算功能上與其他檔案保持一致。

### 目標位置
- **來源檔案**: `Forms/ScoreForm111.cs` 第864行
- **目標檔案**: `Forms/ScoreForm103_1.cs` 第890行

### 當前狀態分析

#### ScoreForm111.cs 第864行 (參考實作)
```csharp
var entryScores = ScoreCalcHelper.CalcSemesterEntryScore(subjRows, sid, g, s, _getScoreCalcRule, _chkSScore);
```

**優勢：**
- ✅ `_getScoreCalcRule` 方法有完整實作
- ✅ 使用 `StudentScoreCalcRules` 字典儲存資料
- ✅ 從 `Utility.GetStudentScoreCalcRules()` 取得實際資料
- ✅ 包含完整的錯誤處理和 XML 解析邏輯
- ✅ 支援動態成績計算規則

#### ScoreForm103_1.cs 第890行 (需要調整)
```csharp
var entryScores = ScoreCalcHelper.CalcSemesterEntryScore(subjRows, sid, g, s, _getScoreCalcRule, _chkSScore);
```

**問題：**
- ❌ `_getScoreCalcRule` 方法僅為範例實作
- ❌ 直接回傳 `null`，沒有實際資料來源
- ❌ 缺少錯誤處理機制
- ❌ 無法支援動態成績計算

### 需要調整的內容

#### 1. 加入 StudentScoreCalcRules 字典宣告
```csharp
// 在 ScoreForm103_1 類別中加入
Dictionary<string, string> StudentScoreCalcRules;
```

#### 2. 在 _bgExporData_DoWork 方法中初始化資料
```csharp
// 在取得再次修習成績後加入
StudentScoreCalcRules = Utility.GetStudentScoreCalcRules(StudentIDList);
```

#### 3. 更新 _getScoreCalcRule 方法實作
```csharp
private System.Xml.XmlElement _getScoreCalcRule(string studentID)
{
    try
    {
        // 檢查是否有學生成績計算規則資料
        if (StudentScoreCalcRules == null || !StudentScoreCalcRules.ContainsKey(studentID))
        {
            return null;
        }

        // 取得學生的成績計算規則 XML 內容
        string xmlContent = StudentScoreCalcRules[studentID];

        // 如果沒有規則內容，回傳 null
        if (string.IsNullOrEmpty(xmlContent))
        {
            return null;
        }

        // 建立 XML 文件並載入內容
        System.Xml.XmlDocument xmlDoc = new System.Xml.XmlDocument();
        xmlDoc.LoadXml(xmlContent);

        // 回傳根元素
        return xmlDoc.DocumentElement;
    }
    catch (Exception ex)
    {
        // 記錄錯誤訊息
        System.Diagnostics.Debug.WriteLine($"解析學生成績計算規則時發生錯誤: {ex.Message}");
        return null;
    }
}
```

### 預期效果
調整完成後，`ScoreForm103_1.cs` 將能夠：
- 正常取得學生成績計算規則
- 支援動態成績計算
- 與 `ScoreForm111.cs` 和 `ScoreForm.cs` 保持功能一致性

### 注意事項
- 確保 `Utility.GetStudentScoreCalcRules()` 方法可用
- 測試 XML 解析邏輯是否正常運作
- 驗證錯誤處理機制是否有效
- 確認成績計算結果的一致性
- 參考已完成調整的 `ScoreForm.cs` 作為實作範例

### 實作優先級
- **優先級**: 高
- **依賴關係**: 依賴於 `ScoreForm.cs` 的調整完成
- **測試建議**: 與 `ScoreForm.cs` 和 `ScoreForm111.cs` 進行交叉測試

---

## Todo 3: 建立 retakeScoreNameMappingDict 字典對照表

### 任務描述
建立 `retakeScoreNameMappingDict` 字典，用於再次修習成績的欄位名稱對照，提升再次修習成績處理的效率和可維護性。

### 目標位置
- **適用檔案**: `Forms/ScoreForm.cs`、`Forms/ScoreForm103_1.cs`、`Forms/ScoreForm111.cs`
- **建議位置**: 在 `_ScoreNameMappingDict` 初始化後建立

### 字典結構設計

#### 字典宣告
```csharp
Dictionary<string, string> retakeScoreNameMappingDict = new Dictionary<string, string>();
```

#### 資料來源
- **Key**: 來自 `_ScoreNameMappingDict` 的 `List<string>` 中的每個科目名稱
- **Value**: 來自 `_ScoreNameMappingDict` 的 key（欄位名稱）

### 建立邏輯

#### 1. 遍歷 _ScoreNameMappingDict
```csharp
foreach (var fieldMapping in _ScoreNameMappingDict)
{
    string fieldName = fieldMapping.Key;           // 欄位名稱 (如: "國語文(高一上)")
    List<string> subjectList = fieldMapping.Value; // 科目列表 (如: ["國語文"])
    
    // 提取學期資訊
    string semesterInfo = ExtractSemesterInfo(fieldName);
    
    // 如果成功提取到學期資訊
    if (!string.IsNullOrEmpty(semesterInfo))
    {
        foreach (string subject in subjectList)
        {
            // 建立複合 key：科目名稱 + 學期資訊
            string compositeKey = subject + semesterInfo;  // 如: "國語文(高一上)"
            
            if (!retakeScoreNameMappingDict.ContainsKey(compositeKey))
            {
                retakeScoreNameMappingDict.Add(compositeKey, fieldName);
            }
        }
    }
}
```

#### 2. 學期資訊提取方法
```csharp
private string ExtractSemesterInfo(string fieldName)
{
    // 檢查欄位名稱包含的學期資訊
    if (fieldName.Contains("(高一上)")) return "(高一上)";
    if (fieldName.Contains("(高一下)")) return "(高一下)";
    if (fieldName.Contains("(高二上)")) return "(高二上)";
    if (fieldName.Contains("(高二下)")) return "(高二下)";
    if (fieldName.Contains("(高三上)")) return "(高三上)";
    if (fieldName.Contains("(高三下)")) return "(高三下)";
    
    // 如果沒有找到學期資訊，回傳空字串
    return "";
}
```

#### 2. 預期結果範例
假設 `_ScoreNameMappingDict` 內容如下：
```csharp
_ScoreNameMappingDict = {
    "國語文(高一上)" => ["國語文"],
    "國語文(高一下)" => ["國語文"],
    "英語文(高一上)" => ["英語文"],
    "英語文(高一下)" => ["英語文"],
    "數學(高一上)" => ["數學"],
    "數學(高一下)" => ["數學"]
}
```

則 `retakeScoreNameMappingDict` 將產生：
```csharp
retakeScoreNameMappingDict = {
    "國語文(高一上)" => "國語文(高一上)",
    "國語文(高一下)" => "國語文(高一下)",
    "英語文(高一上)" => "英語文(高一上)",
    "英語文(高一下)" => "英語文(高一下)",
    "數學(高一上)" => "數學(高一上)",
    "數學(高一下)" => "數學(高一下)"
}
```

**注意：** 使用複合 Key 方式，每個科目+學期組合都有獨立的對照關係，避免 key 衝突問題。

### 使用場景

#### 1. 再次修習成績欄位查找
```csharp
// 原本的複雜查找邏輯
string colName = $"{retake.Subject}({GetGradeSemesterString(g, s)})";

// 使用 retakeScoreNameMappingDict 的簡化查找（複合 Key 方式）
string semesterInfo = $"({GetGradeSemesterString(g, s)})";  // 如: "(高一上)"
string compositeKey = retake.Subject + semesterInfo;        // 如: "國語文(高一上)"

if (retakeScoreNameMappingDict.ContainsKey(compositeKey))
{
    string colName = retakeScoreNameMappingDict[compositeKey];
    // colName 就是 "國語文(高一上)"，直接使用
}
```

#### 2. 提升效能
- 避免重複的字串拼接操作
- 減少欄位名稱的動態生成
- 提供 O(1) 的查找效能

### 實作注意事項

#### 1. 科目名稱唯一性
- 確保科目名稱在不同學期間的唯一性
- 考慮科目級別（如：數學A、數學B）的處理
- 處理科目名稱的空白字元

#### 2. 欄位名稱衝突處理
- **使用複合 Key 方式解決衝突**：將科目名稱與學期資訊組合作為 key
- **避免資料覆蓋**：每個科目+學期組合都有獨立的對照關係
- **支援多學期**：同一科目在不同學期都有對應的欄位名稱
- **查找精確性**：根據科目和學期精確找到對應的欄位

#### 3. 初始化時機
- 在 `_ScoreNameMappingDict` 建立完成後立即建立
- 確保在成績處理邏輯執行前完成初始化

### 預期效果
建立完成後，再次修習成績處理將能夠：
- **快速查找對應的欄位名稱**：使用複合 Key 提供 O(1) 查找效能
- **減少字串操作和記憶體分配**：避免重複的動態字串拼接
- **提升整體程式效能**：特別是在處理大量再次修習成績時
- **簡化再次修習成績的處理邏輯**：清晰的欄位名稱對照關係
- **支援多學期科目**：同一科目在不同學期都有獨立的對照
- **避免資料衝突**：每個科目+學期組合都有唯一的對照關係

### 實作優先級
- **優先級**: 中
- **依賴關係**: 依賴於 `_ScoreNameMappingDict` 的建立
- **測試建議**: 
  - 驗證字典建立邏輯和查找效能
  - 測試多學期科目的對照關係
  - 確認複合 Key 的唯一性
  - 驗證學期資訊提取方法的準確性
- **影響範圍**: 再次修習成績處理相關功能
- **技術特點**: 使用複合 Key 解決科目名稱衝突，支援多學期對照
