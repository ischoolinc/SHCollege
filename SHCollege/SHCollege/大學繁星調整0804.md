# 大學繁星調整0804

## 1. 功能對應檔案
- 大學繁星(高一在校學業成績檔案)：`Forms/ScoreForm103_1.cs`
- 大學繁星(高二在校學業成績檔案)：`Forms/ScoreForm.cs`
- 大學繁星(五學期在校學業成績檔案)：`Forms/ScoreForm111.cs`

---

## 2. 主要程式結構（共通）
- **UI表單**：每個功能對應一個 WinForm，提供欄位設定、匯出、匯入對應表等功能。
- **欄位設定**：可自訂或載入預設欄位（GetDefaultFieldName），欄位對應（FieldMapping）可自訂。
- **資料處理流程**：
  1. 取得選取學生ID
  2. 取得學生基本資料、學期科目成績、學期分項成績
  3. 取得學測報名資料、科別對照、班級代碼
  4. 依欄位設定組成 DataTable
  5. 匯出成 Excel/CSV
- **背景執行**：使用 `BackgroundWorker` 處理資料載入與匯出，避免UI卡頓。
- **匯出/匯入對應表**：可將欄位對應表匯出為Excel，或從Excel匯入。

---

## 3. 各功能差異

### (1) 高一在校學業成績檔案（ScoreForm103_1.cs）
- 預設欄位為高一上下學期各科成績與總平均。
- 欄位名稱如：「學業總平均(高一上)」、「國語文(高一上)」等。
- 主要針對高一學年資料。

### (2) 高二在校學業成績檔案（ScoreForm.cs）
- 預設欄位為高二上下學期各科成績與總平均。
- 欄位名稱如：「學業總平均(高二上)」、「國語文(高二上)」等。
- 主要針對高二學年資料。

### (3) 五學期在校學業成績檔案（ScoreForm111.cs）
- 預設欄位涵蓋高一、高二、高三上（五學期）各科成績與總平均。
- 欄位名稱如：「學業總平均(高一上)」、「學業總平均(高二下)」、「學業總平均(高三上)」等。
- **學業總平均資料來源說明：**
  - 目前三個功能的「學業總平均」欄位，資料來源為「學期分項成績」中的「學業(原始)」或「學業」分項的「成績」欄位。
  - 程式會依據年級、學期、分項名稱自動比對正確的資料行，直接取用該欄位值。
  - **不是即時計算**，而是直接取用學校成績系統已計算好的總平均。
  - 若需即時計算（如現場加總所有科目成績再平均），目前程式尚未實作，需額外撰寫邏輯。

---

## 4. 主要流程（以五學期為例，其他兩者類似）
1. 載入欄位設定（可自訂或預設）
2. 取得學生ID清單
3. 取得學生基本資料、學期科目成績、分項成績、學測報名資料、科別、班級代碼
4. 依欄位設定組成DataTable
5. 比對學期、年級、分項，填入對應成績
6. 匯出Excel/CSV

---

## 5. 主要可調整點
- 欄位預設內容（GetDefaultFieldName）
- 學期、年級、分項成績的比對與填入邏輯
- 匯出檔案格式與命名
- 欄位對應表的自訂與匯入匯出

---

## 6. 討論建議
- 若要調整三個功能，建議可考慮共用邏輯（如資料取得、欄位比對），僅分開處理預設欄位與UI顯示。
- 欄位設定與資料比對邏輯可抽象化，減少重複程式碼。
- 若有新需求（如欄位增減、成績計算方式調整），可集中於預設欄位與比對邏輯調整。

---

如需更細節的欄位或流程圖，請再告知！

---

## 7. ScoreForm111.cs 成績計算規則討論記錄（2024/06/08）

- ScoreForm111.cs 內有明確的成績計算規則：
  - 透過 _ScoreNameMappingDict 及 _CalScoreNameMappingDict 建立欄位與計算規則對應。
  - _CalScoreNameMappingDict 針對有「+」的欄位（如多科目加總）做成績加總或平均。
  - 針對不同學期（如「一上」、「一下」、「三下」等）即時計算科目成績，並存入 ssScoreDict。
  - 最終將加總或平均後的成績寫入 newRow[key] = ssScoreDict[key].GetAverage();
  - ParseSubjScore 會根據是否勾選 _chkSScore 來決定取「原始成績」或「補考成績」較高者。
- 目前僅記錄討論，尚未修改任何程式碼，待確認後再進行實作。

---

## 8. 2024/06/08 補充：ScoreForm111.cs 成績計算依據年級與學期

- ScoreForm111.cs 之 CalcSemesterEntryScore 方法已調整為依據「年級」與「學期」計算分項成績（如學業、體育等）。
- 方法簽名：
  ```csharp
  /// <summary>
  /// 依據學生成績計算規則，計算該生指定年級學期的分項成績（如學業、體育等）。
  /// 注意：本方法以「年級」與「學期」為依據進行資料篩選，非以學年度。
  /// 請確保 subjScoreRows 內的 DataRow 需包含「年級」欄位（dr["年級"]），其值為整數型態（如1、2、3）。
  /// </summary>
  /// <param name="subjScoreRows">該生所有科目成績 DataRow，需包含「年級」欄位</param>
  /// <param name="studentID">學生ID</param>
  /// <param name="gradeYear">年級（如1、2、3）</param>
  /// <param name="semester">學期（如1、2）</param>
  /// <returns>Dictionary，key為分項名稱，value為加權平均分數</returns>
  private Dictionary<string, decimal> CalcSemesterEntryScore(
      List<DataRow> subjScoreRows,
      string studentID,
      int gradeYear,
      int semester)
  ```
- 篩選條件已改為 `dr["年級"] == gradeYear` 且 `dr["學期"] == semester`。
- 請注意：subjScoreRows 來源需確保有「年級」欄位。
- 2024/06/09 補充：分組欄位已由「年級」修正為「成績年級」，以符合資料來源欄位名稱（dr["成績年級"]）。
- 2024/06/09 補充：計算分項成績時，DataRow 欄位名稱已統一為「補修成績」（原「是否補修成績」），以符合 SQL 查詢結果。

---

## 9. 2024/06/09 補充：學期分項成績計算共用化

- 學期分項成績計算邏輯已抽出至 Utility.cs 的 ScoreCalcHelper 靜態方法，三個成績表單（ScoreForm、ScoreForm103_1、ScoreForm111）共用。
- 各 Form 只需呼叫 `ScoreCalcHelper.CalculateAllStudentSemesterEntryScores(SemsSubjDataDict, GetStudentScoreCalcRule)` 即可取得所有學生各年級學期的分項成績。
- 共用類別與方法如下：

```csharp
public enum RoundMode
{
    四捨五入,
    無條件捨去,
    無條件進位
}

public static class ScoreCalcHelper
{
    public static Dictionary<string, Dictionary<(int, int), Dictionary<string, decimal>>>
        CalculateAllStudentSemesterEntryScores(
            Dictionary<string, List<DataRow>> SemsSubjDataDict,
            Func<string, System.Xml.XmlElement> getScoreCalcRule)
    { /* ... */ }

    public static Dictionary<string, decimal> CalcSemesterEntryScore(
        List<DataRow> subjScoreRows,
        string studentID,
        int gradeYear,
        int semester,
        Func<string, System.Xml.XmlElement> getScoreCalcRule)
    { /* ... */ }
}
```

- 詳細用法與參數說明請參考 Utility.cs 內註解。