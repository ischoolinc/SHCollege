# 大學繁星調整0816.md

## Todo 1: 新增再次修習學生資料取得邏輯

### 任務目標
比對 ScoreForm111.cs 與 ScoreForm103_1.cs 的 第 792–880 行，以 ScoreForm111.cs 為主，整理出 ScoreForm103_1.cs 的建議調整項目。

### 差異報告（比對 792–880 行）

#### 1. **新增變數宣告差異**
**ScoreForm111.cs (第792-795行)**：
```csharp
// 取得再次修習學生 ID
List<string> retakeSidList = retakeDict.Keys.ToList();

// 取得再次修習學生學期科目成績，全部都要計算
Dictionary<string, List<DataRow>> retakeSemsSubjDataDict = Utility.GetStudentSemsSubjScoreByStudentID(retakeSidList, false);
```

**ScoreForm103_1.cs**：完全缺少此段程式碼

#### 2. **科目成績覆蓋邏輯差異**
**ScoreForm111.cs (第804行)**：
```csharp
string colName = $"{retake.Subject}({GetGradeSemesterString(gradeYear, retake.Semester)})";
```

**ScoreForm103_1.cs (第820行)**：
```csharp
int g;
int.TryParse(gradeYear, out g);
int s;
int.TryParse(retake.Semester, out s);
string colName = $"{retake.Subject}({GetGradeSemesterString(g, s)})";
```

**差異分析**：
- ScoreForm111.cs 直接使用 string 型別的 `gradeYear` 和 `retake.Semester`
- ScoreForm103_1.cs 先轉換為 int 型別再傳入

#### 3. **再次修習成績資料覆蓋差異**
**ScoreForm111.cs (第825-840行)**：
```csharp
// 需要重新計算使用
if (retakeSemsSubjDataDict.ContainsKey(sid))
{
    var subjRows = retakeSemsSubjDataDict[sid];
    var match = subjRows.FirstOrDefault(r =>
        r["科目"].ToString().Trim() == retake.Subject &&
        r["學期"].ToString() == retake.Semester &&
        (string.IsNullOrEmpty(gradeYear) || r["成績年級"].ToString() == gradeYear) &&
        (string.IsNullOrEmpty(retake.SubjectLevel) || (r.Table.Columns.Contains("科目級別") && r["科目級別"].ToString() == retake.SubjectLevel))
    );
    if (match != null)
    {
        match["原始成績"] = retake.RetakeScore;
        match["補考成績"] = retake.RetakeScore;
    }
}
```

**ScoreForm103_1.cs**：完全缺少此段程式碼

#### 4. **分項成績重新計算資料來源差異**
**ScoreForm111.cs (第860行)**：
```csharp
if (retakeSemsSubjDataDict.ContainsKey(sid))
{
    var subjRows = retakeSemsSubjDataDict[sid];
    // ... 使用 retakeSemsSubjDataDict 進行計算
}
```

**ScoreForm103_1.cs (第860行)**：
```csharp
if (SemsSubjDataDict.ContainsKey(sid))
{
    var subjRows = SemsSubjDataDict[sid];
    // ... 使用 SemsSubjDataDict 進行計算
}
```

**差異分析**：
- ScoreForm111.cs 使用專門的 `retakeSemsSubjDataDict` 進行分項成績計算
- ScoreForm103_1.cs 使用原始的 `SemsSubjDataDict` 進行計算

#### 5. **分項成績欄位處理差異**
**ScoreForm111.cs (第870-885行)**：
```csharp
// 五學期成績
string entryColName = GetEntryFieldName(entry.Key, g, s); // 需實作
if (exportDT.Columns.Contains(entryColName))
    newRow[entryColName] = entry.Value.ToString();

// 高一、高二在校名稱不同
string entryColName1 = GetEntryFieldName(entry.Key, g, s); // 需實作
entryColName1 = entryColName1.Replace("成績", "");
if (exportDT.Columns.Contains(entryColName1))
    newRow[entryColName1] = entry.Value.ToString();
```

**ScoreForm103_1.cs**：完全缺少此段程式碼

### 建議調整清單（以 ScoreForm111.cs 為準）

#### **高優先級調整項目**

1. **新增再次修習學生資料取得邏輯**
   - 位置：在「當+ 科目成績附蓋」區段後，「再次修習成績覆蓋」前
   - 新增 `retakeSidList` 和 `retakeSemsSubjDataDict` 變數宣告

2. **統一科目成績覆蓋邏輯**
   - 移除不必要的 int 型別轉換
   - 直接使用 `GetGradeSemesterString(gradeYear, retake.Semester)` 格式

3. **新增再次修習成績資料覆蓋邏輯**
   - 在科目成績覆蓋後，新增對 `retakeSemsSubjDataDict` 的資料覆蓋
   - 確保再次修習成績能正確覆蓋到專門的資料結構中

#### **中優先級調整項目**

4. **修改分項成績重新計算邏輯**
   - 將分項成績計算改為使用 `retakeSemsSubjDataDict`
   - 確保使用正確的資料來源進行再次修習成績的分項計算

5. **新增五學期成績和高一高二在校成績處理**
   - 實作五學期成績的欄位名稱處理
   - 新增高一高二在校成績的欄位名稱處理邏輯

#### **程式碼結構調整**

6. **變數宣告順序調整**
   - 將 `retakeSidList` 和 `retakeSemsSubjDataDict` 的宣告移到適當位置
   - 確保變數在使用前已正確初始化

7. **邏輯流程統一**
   - 確保再次修習成績的處理流程與 ScoreForm111.cs 完全一致
   - 統一註解格式和程式碼結構

### 預期結果
調整完成後，ScoreForm103_1.cs 的再次修習成績處理邏輯將與 ScoreForm111.cs 保持一致，確保：
- 再次修習成績能正確覆蓋到專門的資料結構
- 分項成績計算使用正確的資料來源
- 五學期成績和高一高二在校成績能正確處理
- 兩個表單的成績計算結果完全一致

### 注意事項
- 調整過程中需確保不影響現有的成績計算邏輯
- 驗證 `Utility.GetStudentSemsSubjScoreByStudentID()` 方法的可用性
- 測試再次修習成績的覆蓋和分項成績重新計算是否正確運作


# Todo 2：ScoreForm 差異比對與調整計畫（先不改程式）

## 任務說明
- 比對 **`ScoreForm111.cs`** 與 **`ScoreForm.cs`** 的 **第 792–880 行**。  
- 以 **`ScoreForm111.cs`** 為主，整理出 **`ScoreForm.cs`** 需要的調整項目。  
- **先不要修改原始程式**，僅需產出差異報告與建議。  
- 將結果補充到 **`大學繁星調整0816.md` → Todo 2** 章節。  

## 預期輸出
1. **差異摘要**  
   - 條列 `ScoreForm111.cs` 與 `ScoreForm.cs` 在 792–880 行的差異。  
   - 說明變數、函式呼叫、條件判斷、例外處理等不同點。  

2. **建議調整清單**  
   - 以 `ScoreForm111.cs` 為準，列出對 `ScoreForm.cs` 的修改建議。  
   - 每項建議需包含：差異點 → 調整方式 → 理由。  

3. **更新 `大學繁星調整0816.md`**  
   - 在 **Todo 2** 章節補充：  
     - 差異摘要（重點條列）  
     - 調整建議（依 111 規則）  
     - 可能影響與測試提醒  

## 注意事項
- ❌ 不要修改 `ScoreForm111.cs` 或 `ScoreForm.cs` 原始碼。  
- ✅ 只需生成報告內容，補充到 `大學繁星調整0816.md`。  
- 若行號略有偏移，請以實際對應區塊為準並註明。  